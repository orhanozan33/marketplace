import express from 'express';
import multer from 'multer';
import path from 'path';
import { fileURLToPath } from 'url';
import fs from 'fs';
import cors from 'cors';
import { v4 as uuidv4 } from 'uuid';
import { initDatabase, dbQuery, loadDatabase, saveDatabase } from './database/database.js';
import { registerUser, loginUser, authenticateToken, requireAdmin, getUserById } from './auth/auth.js';
import { getActiveAds, getAllAds, updateAd, deleteAd } from './advertisements/advertisements.js';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;

// VeritabanÄ±nÄ± baÅŸlat
initDatabase();

// CORS ayarlarÄ±
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}));

// TÃ¼m istekleri logla
app.use((req, res, next) => {
  // Profil gÃ¼ncelleme isteklerini Ã¶zellikle logla
  if (req.url.includes('/api/users/') && req.url.includes('/profile') && req.method === 'PUT') {
    console.log('');
    console.log('ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨');
    console.log('ğŸš¨ğŸš¨ğŸš¨ PROFÄ°L GÃœNCELLEME Ä°STEÄÄ° GLOBAL MIDDLEWARE\'DE! ğŸš¨ğŸš¨ğŸš¨');
    console.log('ğŸš¨ Method:', req.method);
    console.log('ğŸš¨ URL:', req.url);
    console.log('ğŸš¨ Original URL:', req.originalUrl);
    console.log('ğŸš¨ Path:', req.path);
    console.log('ğŸš¨ Content-Type:', req.get('Content-Type'));
    console.log('ğŸš¨ Headers:', JSON.stringify(req.headers, null, 2));
    console.log('ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨ğŸš¨');
    console.log('');
  }
  // KullanÄ±cÄ± profil isteklerini Ã¶zellikle logla
  if (req.url.match(/^\/api\/users\/[^\/]+$/) && req.method === 'GET' && !req.url.includes('/profile')) {
    console.log('');
    console.log('ğŸ‘¤ğŸ‘¤ğŸ‘¤ KULLANICI PROFÄ°L Ä°STEÄÄ° GLOBAL MIDDLEWARE\'DE! ğŸ‘¤ğŸ‘¤ğŸ‘¤');
    console.log('ğŸ‘¤ Method:', req.method);
    console.log('ğŸ‘¤ URL:', req.url);
    console.log('ğŸ‘¤ Original URL:', req.originalUrl);
    console.log('ğŸ‘¤ Path:', req.path);
    console.log('');
  }
  console.log('ğŸŒ Ä°stek alÄ±ndÄ±:', req.method, req.url);
  console.log('ğŸŒ Content-Type:', req.get('Content-Type'));
  console.log('ğŸŒ User-Agent:', req.get('User-Agent')?.substring(0, 50));
  next();
});

// JSON ve form data desteÄŸi
// Ã–NEMLÄ°: express.json() ve urlencoded() multer ile Ã§akÄ±ÅŸabilir
// Bu yÃ¼zden sadece JSON ve urlencoded istekler iÃ§in kullanÄ±yoruz
// Multer route'larÄ± iÃ§in bu middleware'ler Ã§alÄ±ÅŸmayacak
const jsonMiddleware = express.json();
const urlencodedMiddleware = express.urlencoded({ extended: true });

app.use((req, res, next) => {
  const contentType = req.get('Content-Type') || '';
  
  // Profil gÃ¼ncelleme endpoint'i iÃ§in json/urlencoded kullanma
  if (req.url.includes('/api/users/') && req.url.includes('/profile') && req.method === 'PUT') {
    console.log('â­ï¸ Profil gÃ¼ncelleme endpoint - json/urlencoded atlanÄ±yor');
    console.log('ğŸ” URL:', req.url);
    console.log('ğŸ” Method:', req.method);
    console.log('ğŸ” Content-Type:', contentType);
    return next();
  }
  
  if (contentType.includes('multipart/form-data')) {
    console.log('â­ï¸ Multipart istek - json/urlencoded atlanÄ±yor');
    return next();
  }
  
  if (contentType.includes('application/json')) {
    return jsonMiddleware(req, res, next);
  }
  
  if (contentType.includes('application/x-www-form-urlencoded')) {
    return urlencodedMiddleware(req, res, next);
  }
  
  // Content-Type yoksa veya baÅŸka bir ÅŸeyse, json dene
  jsonMiddleware(req, res, next);
});

// Uploads klasÃ¶rÃ¼nÃ¼ oluÅŸtur
const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}

// Alt klasÃ¶rler oluÅŸtur
const listingsDir = path.join(uploadsDir, 'listings');
if (!fs.existsSync(listingsDir)) {
  fs.mkdirSync(listingsDir, { recursive: true });
}

const advertisementsDir = path.join(uploadsDir, 'advertisements');
if (!fs.existsSync(advertisementsDir)) {
  fs.mkdirSync(advertisementsDir, { recursive: true });
}

// Multer yapÄ±landÄ±rmasÄ±
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    // FormData'dan folder'Ä± al (multer body'yi parse etmeden Ã¶nce Ã§alÄ±ÅŸÄ±r, bu yÃ¼zden req.body boÅŸ olabilir)
    // Alternatif: req.query veya header'dan al, ya da dosya yolu iÃ§inden Ã§Ä±kar
    let folder = 'listings'; // VarsayÄ±lan
    
    // FormData'dan folder'Ä± almak iÃ§in Ã¶zel bir middleware gerekebilir
    // Åimdilik endpoint'lerde manuel olarak kontrol edeceÄŸiz
    // Ama burada da kontrol edelim
    if (req.body && req.body.folder) {
      folder = req.body.folder;
    } else if (req.query && req.query.folder) {
      folder = req.query.folder;
    }
    
    const folderPath = path.join(uploadsDir, folder);
    
    // KlasÃ¶r yoksa oluÅŸtur
    if (!fs.existsSync(folderPath)) {
      fs.mkdirSync(folderPath, { recursive: true });
    }
    
    console.log(`ğŸ“ Multer destination: ${folderPath} (folder: ${folder})`);
    cb(null, folderPath);
  },
  filename: (req, file, cb) => {
    // Dosya adÄ±nÄ± temizle ve benzersiz yap
    const timestamp = Date.now();
    const sanitizedName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
    const ext = path.extname(sanitizedName);
    const name = path.basename(sanitizedName, ext);
    const uniqueName = `${timestamp}_${name}${ext}`;
    cb(null, uniqueName);
  }
});

// Dosya filtreleme (sadece resimler)
const fileFilter = (req, file, cb) => {
  const allowedTypes = /jpeg|jpg|png|gif|webp/;
  const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
  const mimetype = allowedTypes.test(file.mimetype);

  if (mimetype && extname) {
    return cb(null, true);
  } else {
    cb(new Error('Sadece resim dosyalarÄ± yÃ¼klenebilir (JPEG, PNG, GIF, WEBP)'));
  }
};

// Multer middleware
const upload = multer({
  storage: storage,
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
  },
  fileFilter: fileFilter
});

// Statik dosya servisi (yÃ¼klenen resimleri gÃ¶ster)
app.use('/uploads', express.static(uploadsDir));

// Health check
app.get('/api/health', (req, res) => {
  res.json({ status: 'ok', message: 'Backend server is running' });
});

// ==================== AUTH ROUTES ====================

// KullanÄ±cÄ± kayÄ±t
app.post('/api/auth/register', async (req, res) => {
  try {
    const { email, password, displayName, phone, postalCode } = req.body;
    
    if (!email || !password) {
      return res.status(400).json({ error: 'Email ve ÅŸifre gerekli' });
    }

    if (!phone || !postalCode) {
      return res.status(400).json({ error: 'Telefon ve posta kodu zorunludur' });
    }

    const result = await registerUser(email, password, displayName, phone, postalCode);
    res.json(result);
  } catch (error) {
    res.status(400).json({ error: error.message });
  }
});

// KullanÄ±cÄ± giriÅŸ
app.post('/api/auth/login', async (req, res) => {
  try {
    console.log('ğŸ” Login isteÄŸi alÄ±ndÄ±:', req.body);
    const { email, password } = req.body;
    
    if (!email || !password) {
      console.log('âŒ Email veya ÅŸifre eksik');
      return res.status(400).json({ error: 'Email ve ÅŸifre gerekli' });
    }

    console.log('âœ… Login fonksiyonu Ã§aÄŸrÄ±lÄ±yor...');
    const result = await loginUser(email, password);
    console.log('âœ… Login baÅŸarÄ±lÄ±:', result.user?.email);
    res.json(result);
  } catch (error) {
    console.error('âŒ Login hatasÄ±:', error.message);
    res.status(401).json({ error: error.message });
  }
});

// KullanÄ±cÄ± bilgilerini al
app.get('/api/auth/me', authenticateToken, (req, res) => {
  const user = dbQuery.getUserById(req.userId);
  if (user) {
    const { password: _, ...userWithoutPassword } = user;
    console.log('ğŸ“¤ /api/auth/me - KullanÄ±cÄ± bilgileri:', {
      id: userWithoutPassword.id,
      photoURL: userWithoutPassword.photoURL,
      displayName: userWithoutPassword.displayName
    });
    res.json({ user: userWithoutPassword });
  } else {
    res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
  }
});

// ==================== LISTINGS ROUTES ====================

// TÃ¼m ilanlarÄ± getir
app.get('/api/listings', (req, res) => {
  try {
    const { category, status, includeSold } = req.query;
    
    // Admin paneli iÃ§in tÃ¼m ilanlarÄ± gÃ¶ster (status filtresi yoksa)
    const filters = {};
    if (category) filters.category = category;
    if (status) filters.status = status;
    
    console.log('ğŸ“‹ GET /api/listings - Filtreler:', filters, 'includeSold:', includeSold);
    let listings = dbQuery.getListings(filters);
    
    // SatÄ±lan ilanlarÄ± kontrol et
    const soldListings = dbQuery.getSoldListings();
    const soldListingIds = new Set(soldListings.map(sale => sale.listingId));
    
    // EÄŸer includeSold parametresi yoksa satÄ±lan ilanlarÄ± filtrele
    if (!includeSold || includeSold !== 'true') {
      console.log('ğŸ” SatÄ±lan ilanlar:', soldListings.length, soldListings.map(s => s.listingId));
      const beforeFilterCount = listings.length;
      listings = listings.filter(listing => !soldListingIds.has(listing.id));
      const afterFilterCount = listings.length;
      console.log('ğŸ“‹ Filtreleme Ã¶ncesi:', beforeFilterCount, 'ilan');
      console.log('ğŸ“‹ Filtreleme sonrasÄ±:', afterFilterCount, 'ilan (satÄ±lanlar Ã§Ä±karÄ±ldÄ±)');
      console.log('ğŸ“‹ Backend\'den dÃ¶nen ilan sayÄ±sÄ± (satÄ±lanlar hariÃ§):', listings.length);
    } else {
      console.log('ğŸ“‹ SatÄ±lan ilanlar dahil ediliyor');
      console.log('ğŸ“‹ SatÄ±lan ilan ID\'leri:', Array.from(soldListingIds));
      // Her ilan iÃ§in isSold flag'ini ekle
      listings = listings.map(listing => {
        const isSold = soldListingIds.has(listing.id);
        if (isSold) {
          console.log('âœ… Ä°lan satÄ±ldÄ± olarak iÅŸaretlendi:', listing.id, listing.title);
        }
        return {
          ...listing,
          isSold: isSold
        };
      });
      console.log('ğŸ“‹ Toplam ilan sayÄ±sÄ± (satÄ±lanlar dahil):', listings.length);
      console.log('ğŸ“‹ SatÄ±lan ilan sayÄ±sÄ±:', listings.filter(l => l.isSold).length);
      console.log('ğŸ“‹ SatÄ±lan ilanlar:', listings.filter(l => l.isSold).map(l => ({ id: l.id, title: l.title, userId: l.userId })));
    }
    if (listings.length > 0) {
      console.log('ğŸ“‹ Ä°lk ilan:', { id: listings[0].id, title: listings[0].title, userId: listings[0].userId });
    }
    
    // Listing details'leri de ekle
    const listingsWithDetails = listings.map(listing => {
      let details = {};
      try {
        details = dbQuery.getListingDetails(listing.id);
        if (listing.category === 'housing' && Object.keys(details || {}).length > 0) {
          console.log(`ğŸ“– Ä°lan ${listing.id} iÃ§in details bulundu:`, details);
        }
      } catch (detailsError) {
        console.error(`âŒ Ä°lan ${listing.id} iÃ§in details okunurken hata:`, detailsError);
        details = {};
      }
      
      // Resim URL'lerini dÃ¼zelt (relative URL ise full URL'e Ã§evir)
      let imageUrl = listing.image;
      let imagesArray = [];
      try {
        imagesArray = listing.images ? (typeof listing.images === 'string' ? JSON.parse(listing.images) : listing.images) : [listing.image].filter(Boolean);
      } catch (parseError) {
        console.error(`âŒ Ä°lan ${listing.id} iÃ§in images parse edilirken hata:`, parseError);
        imagesArray = listing.image ? [listing.image] : [];
      }
      
      // URL'leri normalize et (userId klasÃ¶rÃ¼nÃ¼ kaldÄ±r)
      const normalizeImageUrl = (url) => {
        if (!url) return url;
        try {
          // EÄŸer userId klasÃ¶rÃ¼ varsa kaldÄ±r (eski format: /uploads/listings/userId/filename)
          // Yeni format: /uploads/listings/filename
          if (url.includes('/uploads/listings/')) {
            const parts = url.split('/uploads/listings/');
            if (parts.length > 1) {
              const filename = parts[1].split('/').pop(); // Son kÄ±smÄ± al (filename)
              url = `/uploads/listings/${filename}`;
            }
          }
          // Relative URL'leri full URL'e Ã§evir
          if (url.startsWith('/uploads/')) {
            url = `${req.protocol}://${req.get('host')}${url}`;
          }
        } catch (urlError) {
          console.error(`âŒ URL normalize edilirken hata:`, urlError);
        }
        return url;
      };
      
      imageUrl = normalizeImageUrl(imageUrl);
      imagesArray = imagesArray.map(normalizeImageUrl).filter(Boolean);
      
      // VideolarÄ± parse et
      let videosArray = [];
      try {
        videosArray = listing.videos ? (typeof listing.videos === 'string' ? JSON.parse(listing.videos) : listing.videos) : [];
        videosArray = videosArray.map(normalizeImageUrl).filter(Boolean);
      } catch (videoError) {
        console.error(`âŒ Ä°lan ${listing.id} iÃ§in videos parse edilirken hata:`, videoError);
        videosArray = [];
      }
      
      // KullanÄ±cÄ± bilgilerini al (telefon numarasÄ± iÃ§in)
      const listingUser = dbQuery.getUserById(listing.userId);
      
      // Debug log
      if (listing.category === 'housing' && Object.keys(details || {}).length > 0) {
        console.log(`ğŸ“¤ Ä°lan ${listing.id} iÃ§in details:`, details);
      }
      
      // isSold flag'ini aÃ§Ä±kÃ§a koru (spread operator ile kaybolabilir)
      const isSoldValue = listing.isSold === true || listing.isSold === 'true' || listing.isSold === 1 || listing.isSold === '1';
      
      return {
        ...listing,
        position: [listing.latitude, listing.longitude],
        details: details || {},
        image: imageUrl || imagesArray[0] || `https://placehold.co/300x200/3B82F6/white?text=${listing.category}`,
        images: imagesArray.length > 0 ? imagesArray : [imageUrl || `https://placehold.co/300x200/3B82F6/white?text=${listing.category}`].filter(Boolean),
        videos: videosArray,
        userPhone: listingUser?.phone || null, // KullanÄ±cÄ± telefon numarasÄ±
        userDisplayName: listingUser?.displayName || null, // KullanÄ±cÄ± adÄ±
        userPhotoURL: listingUser?.photoURL || null, // KullanÄ±cÄ± profil resmi
        showPhone: listing.showPhone !== undefined ? listing.showPhone : true,
        price: typeof listing.price === 'string' ? parseFloat(listing.price) || 0 : (listing.price || 0),
        createdAt: listing.createdAt,
        created_at: listing.createdAt,
        isSold: isSoldValue  // isSold flag'ini aÃ§Ä±kÃ§a set et
      };
    });
    
    // Debug: isSold flag'lerini kontrol et
    if (includeSold === 'true') {
      const soldCount = listingsWithDetails.filter(l => l.isSold === true).length;
      console.log('ğŸ“‹ Response\'da satÄ±lan ilan sayÄ±sÄ±:', soldCount);
      console.log('ğŸ“‹ Response\'da satÄ±lan ilanlar:', listingsWithDetails.filter(l => l.isSold === true).map(l => ({ id: l.id, title: l.title, userId: l.userId, isSold: l.isSold })));
      console.log('ğŸ“‹ Response\'da tÃ¼m ilanlarÄ±n isSold deÄŸerleri:', listingsWithDetails.map(l => ({ id: l.id, title: l.title, isSold: l.isSold, isSoldType: typeof l.isSold })));
    }
    
    res.json(listingsWithDetails);
  } catch (error) {
    console.error('Error fetching listings:', error);
    res.status(500).json({ error: 'Ä°lanlar yÃ¼klenirken hata oluÅŸtu' });
  }
});

// Tek ilan getir
app.get('/api/listings/:id', (req, res) => {
  try {
    const listing = dbQuery.getListingById(req.params.id);
    
    if (!listing) {
      return res.status(404).json({ error: 'Ä°lan bulunamadÄ±' });
    }
    
    console.log('ğŸ“– Tek ilan getiriliyor:', listing.id);
    const details = dbQuery.getListingDetails(listing.id);
    console.log('ğŸ“– Details sonucu:', details, 'Keys:', Object.keys(details || {}));
    
    // Resim URL'lerini dÃ¼zelt
    let imageUrl = listing.image;
    let imagesArray = listing.images ? (typeof listing.images === 'string' ? JSON.parse(listing.images) : listing.images) : [listing.image].filter(Boolean);
    
    // URL'leri normalize et (userId klasÃ¶rÃ¼nÃ¼ kaldÄ±r)
    const normalizeImageUrl = (url) => {
      if (!url) return url;
      // EÄŸer userId klasÃ¶rÃ¼ varsa kaldÄ±r (eski format: /uploads/listings/userId/filename)
      // Yeni format: /uploads/listings/filename
      if (url.includes('/uploads/listings/')) {
        const parts = url.split('/uploads/listings/');
        if (parts.length > 1) {
          const filename = parts[1].split('/').pop(); // Son kÄ±smÄ± al (filename)
          url = `/uploads/listings/${filename}`;
        }
      }
      // Relative URL'leri full URL'e Ã§evir
      if (url.startsWith('/uploads/')) {
        url = `${req.protocol}://${req.get('host')}${url}`;
      }
      return url;
    };
    
    imageUrl = normalizeImageUrl(imageUrl);
    imagesArray = imagesArray.map(normalizeImageUrl);
    
    // VideolarÄ± parse et
    let videosArray = listing.videos ? (typeof listing.videos === 'string' ? JSON.parse(listing.videos) : listing.videos) : [];
    videosArray = videosArray.map(normalizeImageUrl);
    
    // KullanÄ±cÄ± bilgilerini al (telefon numarasÄ± iÃ§in)
    const listingUser = dbQuery.getUserById(listing.userId);
    
    console.log('ğŸ“¤ Tek ilan getiriliyor:', listing.id);
    console.log('ğŸ“¤ Details:', details);
    console.log('ğŸ“¤ Details keys:', Object.keys(details || {}));
    
    res.json({
      ...listing,
      position: [listing.latitude, listing.longitude],
      details: details || {},
      image: imageUrl || imagesArray[0] || `https://placehold.co/300x200/3B82F6/white?text=${listing.category}`,
      images: imagesArray.length > 0 ? imagesArray : [imageUrl || `https://placehold.co/300x200/3B82F6/white?text=${listing.category}`],
      videos: videosArray,
      userPhone: listingUser?.phone || null, // KullanÄ±cÄ± telefon numarasÄ±
      userDisplayName: listingUser?.displayName || null, // KullanÄ±cÄ± adÄ±
      userPhotoURL: listingUser?.photoURL || null, // KullanÄ±cÄ± profil resmi
      showPhone: listing.showPhone !== undefined ? listing.showPhone : true
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Yeni ilan oluÅŸtur
app.post('/api/listings', authenticateToken, (req, res) => {
  try {
    const listingData = req.body;
    
    const listing = dbQuery.createListing({
      userId: req.userId,
      category: listingData.category,
      title: listingData.title,
      description: listingData.description || '',
      price: listingData.price || 0,
      latitude: listingData.latitude || listingData.position?.[0] || 49.2827,
      longitude: listingData.longitude || listingData.position?.[1] || -123.1207,
      address: listingData.address || listingData.postalCode || '',
      postalCode: listingData.postalCode || '',
      city: listingData.city || '',
      province: listingData.province || '',
      image: listingData.image || '',
      images: JSON.stringify(listingData.images || [listingData.image].filter(Boolean)),
      videos: JSON.stringify(listingData.videos || []),
      showPhone: listingData.showPhone !== undefined ? listingData.showPhone : true,
      status: listingData.status || 'active',
      views: 0,
      // Housing listing alanlarÄ±
      listingType: listingData.listingType || null,
      propertyType: listingData.propertyType || null,
      bedrooms: listingData.bedrooms || null,
      bathrooms: listingData.bathrooms || null,
      sqft: listingData.sqft || null,
      userPhone: listingData.userPhone || null
    });
    
    // Details varsa kaydet
    console.log('ğŸ“¥ Ä°lan oluÅŸturuluyor, details:', listingData.details);
    console.log('ğŸ“¥ Details keys:', listingData.details ? Object.keys(listingData.details) : 'null');
    if (listingData.details && Object.keys(listingData.details).length > 0) {
      console.log('ğŸ’¾ Details kaydediliyor:', listingData.details);
      dbQuery.saveListingDetails(listing.id, listingData.details);
    } else {
      console.log('âš ï¸ Details boÅŸ veya yok, kaydedilmiyor');
    }
    
    const details = dbQuery.getListingDetails(listing.id);
    
    // KullanÄ±cÄ± bilgilerini al (telefon numarasÄ± iÃ§in)
    const listingUser = dbQuery.getUserById(listing.userId);
    
    res.status(201).json({
      ...listing,
      position: [listing.latitude, listing.longitude],
      details: details || {},
      images: listing.images ? (typeof listing.images === 'string' ? JSON.parse(listing.images) : listing.images) : [listing.image].filter(Boolean),
      videos: listing.videos ? (typeof listing.videos === 'string' ? JSON.parse(listing.videos) : listing.videos) : [],
      userPhone: listingUser?.phone || null, // KullanÄ±cÄ± telefon numarasÄ±
      userDisplayName: listingUser?.displayName || null, // KullanÄ±cÄ± adÄ±
      userPhotoURL: listingUser?.photoURL || null, // KullanÄ±cÄ± profil resmi
      showPhone: listing.showPhone !== undefined ? listing.showPhone : true
    });
  } catch (error) {
    console.error('Error creating listing:', error);
    res.status(500).json({ error: error.message || 'Ä°lan oluÅŸturulurken hata oluÅŸtu' });
  }
});

// Ä°lan gÃ¼ncelle
app.put('/api/listings/:id', authenticateToken, (req, res) => {
  try {
    const listing = dbQuery.getListingById(req.params.id);
    
    if (!listing) {
      return res.status(404).json({ error: 'Ä°lan bulunamadÄ±' });
    }
    
    // Sadece ilan sahibi veya admin gÃ¼ncelleyebilir
    const user = getUserById(req.userId);
    if (listing.userId !== req.userId && user?.role !== 'admin' && user?.role !== 'superadmin') {
      return res.status(403).json({ error: 'Bu iÅŸlem iÃ§in yetkiniz yok' });
    }
    
    const updateData = req.body;
    const updates = {};
    
    if (updateData.title !== undefined) updates.title = updateData.title;
    if (updateData.description !== undefined) updates.description = updateData.description;
    if (updateData.price !== undefined) updates.price = updateData.price;
    if (updateData.latitude !== undefined || updateData.position) updates.latitude = updateData.latitude || updateData.position?.[0];
    if (updateData.longitude !== undefined || updateData.position) updates.longitude = updateData.longitude || updateData.position?.[1];
    if (updateData.address !== undefined) updates.address = updateData.address;
    if (updateData.city !== undefined) updates.city = updateData.city;
    if (updateData.postalCode !== undefined) updates.postalCode = updateData.postalCode;
    if (updateData.image !== undefined) updates.image = updateData.image;
    if (updateData.images !== undefined) updates.images = JSON.stringify(updateData.images);
    if (updateData.videos !== undefined) updates.videos = JSON.stringify(updateData.videos);
    if (updateData.showPhone !== undefined) updates.showPhone = updateData.showPhone;
    if (updateData.status !== undefined) updates.status = updateData.status;
    // Housing listing alanlarÄ±
    if (updateData.listingType !== undefined) updates.listingType = updateData.listingType;
    if (updateData.propertyType !== undefined) updates.propertyType = updateData.propertyType;
    if (updateData.bedrooms !== undefined) updates.bedrooms = updateData.bedrooms;
    if (updateData.bathrooms !== undefined) updates.bathrooms = updateData.bathrooms;
    if (updateData.sqft !== undefined) updates.sqft = updateData.sqft;
    if (updateData.userPhone !== undefined) updates.userPhone = updateData.userPhone;
    
    // Fiyat deÄŸiÅŸikliÄŸi kontrolÃ¼
    const oldPrice = listing.price;
    const newPrice = updateData.price;
    const priceChanged = newPrice !== undefined && oldPrice !== undefined && newPrice !== oldPrice;
    
    const updated = dbQuery.updateListing(req.params.id, updates);
    
    // Fiyat dÃ¼ÅŸtÃ¼yse ilanla mesajlaÅŸan kullanÄ±cÄ±lara bildirim gÃ¶nder
    if (priceChanged && newPrice < oldPrice) {
      const messageUsers = dbQuery.getListingMessageUsers(req.params.id);
      const priceDifference = oldPrice - newPrice;
      
      messageUsers.forEach(userId => {
        dbQuery.createNotification({
          userId,
          listingId: req.params.id,
          type: 'price_drop',
          title: 'Fiyat DÃ¼ÅŸtÃ¼!',
          message: `"${listing.title}" ilanÄ±nda fiyat ${oldPrice} TL'den ${newPrice} TL'ye dÃ¼ÅŸÃ¼rÃ¼ldÃ¼. Bu bir fÄ±rsat! (${priceDifference} TL indirim)`,
          listingTitle: listing.title,
          oldPrice,
          newPrice
        });
      });
    }
    
    // Details varsa kaydet (false deÄŸerleri de dahil)
    console.log('ğŸ“¥ Ä°lan gÃ¼ncelleniyor, details:', updateData.details);
    console.log('ğŸ“¥ Details keys:', updateData.details ? Object.keys(updateData.details) : 'null');
    console.log('ğŸ“¥ Details deÄŸerleri:', updateData.details ? Object.entries(updateData.details) : 'null');
    if (updateData.details && typeof updateData.details === 'object' && Object.keys(updateData.details).length > 0) {
      console.log('ğŸ’¾ Details kaydediliyor (false deÄŸerleri de dahil):', updateData.details);
      dbQuery.saveListingDetails(req.params.id, updateData.details);
    } else {
      console.log('âš ï¸ Details boÅŸ veya yok, kaydedilmiyor');
    }
    
    const details = dbQuery.getListingDetails(req.params.id);
    console.log('ğŸ“– GÃ¼ncellenmiÅŸ ilan iÃ§in details okundu:', details);
    console.log('ğŸ“– Details keys:', Object.keys(details || {}));
    
    // KullanÄ±cÄ± bilgilerini al (telefon numarasÄ± iÃ§in)
    const listingUser = dbQuery.getUserById(updated.userId);
    
    const responseData = {
      ...updated,
      position: [updated.latitude, updated.longitude],
      details: details || {},
      images: updated.images ? (typeof updated.images === 'string' ? JSON.parse(updated.images) : updated.images) : [updated.image].filter(Boolean),
      videos: updated.videos ? (typeof updated.videos === 'string' ? JSON.parse(updated.videos) : updated.videos) : [],
      userPhone: listingUser?.phone || null,
      userDisplayName: listingUser?.displayName || null, // KullanÄ±cÄ± adÄ±
      userPhotoURL: listingUser?.photoURL || null, // KullanÄ±cÄ± profil resmi
      showPhone: updated.showPhone !== undefined ? updated.showPhone : true
    };
    
    console.log('ğŸ“¤ Response gÃ¶nderiliyor, details:', responseData.details);
    console.log('ğŸ“¤ Response details keys:', Object.keys(responseData.details || {}));
    
    res.json(responseData);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Ä°lan sil
app.delete('/api/listings/:id', authenticateToken, (req, res) => {
  try {
    const listing = dbQuery.getListingById(req.params.id);
    
    if (!listing) {
      return res.status(404).json({ error: 'Ä°lan bulunamadÄ±' });
    }
    
    // Sadece ilan sahibi veya admin silebilir
    const user = getUserById(req.userId);
    if (listing.userId !== req.userId && user?.role !== 'admin' && user?.role !== 'superadmin') {
      return res.status(403).json({ error: 'Bu iÅŸlem iÃ§in yetkiniz yok' });
    }
    
    dbQuery.deleteListing(req.params.id);
    res.json({ success: true, message: 'Ä°lan silindi' });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ==================== MESSAGES ROUTES ====================

// Mesaj gÃ¶nder
app.post('/api/messages', authenticateToken, (req, res) => {
  try {
    const { listingId, receiverId, message } = req.body;
    
    if (!listingId || !receiverId || !message) {
      return res.status(400).json({ error: 'listingId, receiverId ve message gerekli' });
    }
    
    const newMessage = dbQuery.createMessage({
      listingId,
      senderId: req.userId,
      receiverId,
      message,
      read: false
    });
    
    res.status(201).json(newMessage);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// MesajlarÄ± getir
app.get('/api/messages', authenticateToken, (req, res) => {
  try {
    console.log('ğŸ“¥ Messages isteÄŸi alÄ±ndÄ±, userId:', req.userId);
    const { listingId, otherUserId } = req.query;
    console.log('ğŸ“¥ Query params:', { listingId, otherUserId });
    
    const messages = dbQuery.getMessages({
      userId: req.userId,
      listingId,
      otherUserId
    });
    console.log('âœ… Messages yÃ¼klendi, sayÄ±:', messages?.length || 0);
    
    if (!Array.isArray(messages)) {
      console.error('âŒ Messages bir array deÄŸil:', typeof messages);
      return res.status(500).json({ error: 'Mesajlar yÃ¼klenemedi' });
    }
    
    // Mesajlara gÃ¶nderen kullanÄ±cÄ± bilgilerini ekle
    const allUsers = dbQuery.getUsers();
    console.log('âœ… Users yÃ¼klendi, sayÄ±:', allUsers?.length || 0);
    
    if (!Array.isArray(allUsers)) {
      console.error('âŒ Users bir array deÄŸil:', typeof allUsers);
      return res.status(500).json({ error: 'KullanÄ±cÄ±lar yÃ¼klenemedi' });
    }
    
    const messagesWithSenders = messages.map(msg => {
      try {
        if (!msg || !msg.senderId) {
          console.warn('âš ï¸ GeÃ§ersiz mesaj:', msg);
          return {
            ...msg,
            senderName: 'KullanÄ±cÄ±',
            senderPhotoURL: null
          };
        }
        
        const sender = allUsers.find(u => u && u.id === msg.senderId);
        // displayName varsa ve boÅŸ deÄŸilse kullan, yoksa email kullan
        const senderName = sender?.displayName?.trim() 
          ? sender.displayName.trim() 
          : (sender?.email || 'KullanÄ±cÄ±');
        return {
          ...msg,
          senderName: senderName,
          senderPhotoURL: sender?.photoURL || null
        };
      } catch (mapError) {
        console.error('âŒ Message map hatasÄ±:', mapError);
        return {
          ...msg,
          senderName: 'KullanÄ±cÄ±',
          senderPhotoURL: null
        };
      }
    });
    
    console.log('âœ… Messages with senders hazÄ±r, sayÄ±:', messagesWithSenders.length);
    res.json(messagesWithSenders);
  } catch (error) {
    console.error('âŒ Messages endpoint hatasÄ±:', error);
    console.error('âŒ Hata detayÄ±:', error.stack);
    res.status(500).json({ error: error.message || 'Mesajlar yÃ¼klenirken hata oluÅŸtu' });
  }
});

// Mesaj sil (KullanÄ±cÄ± - hem gÃ¶nderen hem de alÄ±cÄ± silebilir)
app.delete('/api/messages/:id', authenticateToken, (req, res) => {
  try {
    const message = dbQuery.getMessageById(req.params.id);
    
    if (!message) {
      return res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
    
    // Hem gÃ¶nderen hem de alÄ±cÄ± mesajÄ± silebilir
    if (message.senderId !== req.userId && message.receiverId !== req.userId) {
      return res.status(403).json({ error: 'Bu mesajÄ± silme yetkiniz yok' });
    }
    
    console.log('ğŸ—‘ï¸ API: Mesaj silme isteÄŸi:', {
      messageId: req.params.id,
      userId: req.userId,
      senderId: message.senderId,
      receiverId: message.receiverId,
      currentDeletedFor: message.deletedFor
    });
    
    const deleted = dbQuery.deleteMessage(req.params.id, req.userId);
    if (deleted) {
      // Silme iÅŸleminden sonra mesajÄ± tekrar kontrol et
      const updatedMessage = dbQuery.getMessageById(req.params.id);
      console.log('âœ… API: Mesaj silme sonrasÄ± durum:', {
        messageId: req.params.id,
        stillExists: !!updatedMessage,
        deletedFor: updatedMessage?.deletedFor
      });
      res.json({ success: true, message: 'Mesaj silindi' });
    } else {
      res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
  } catch (error) {
    console.error('âŒ API: Mesaj silme hatasÄ±:', error);
    res.status(500).json({ error: error.message });
  }
});

// KonuÅŸma sil (tÃ¼m mesajlarÄ± sil)
app.delete('/api/conversations', authenticateToken, (req, res) => {
  try {
    const { otherUserId, listingId } = req.query;
    
    if (!otherUserId || !listingId) {
      return res.status(400).json({ error: 'otherUserId ve listingId gerekli' });
    }
    
    const deletedCount = dbQuery.deleteConversation(req.userId, otherUserId, listingId);
    res.json({ success: true, deletedCount });
  } catch (error) {
    console.error('âŒ KonuÅŸma silme hatasÄ±:', error);
    res.status(500).json({ error: error.message || 'KonuÅŸma silinirken hata oluÅŸtu' });
  }
});

// MesajÄ± okundu olarak iÅŸaretle
app.put('/api/messages/:id/read', authenticateToken, (req, res) => {
  try {
    const message = dbQuery.getMessageById(req.params.id);
    
    if (!message) {
      return res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
    
    // Sadece mesaj alÄ±cÄ±sÄ± okundu olarak iÅŸaretleyebilir
    if (message.receiverId !== req.userId) {
      return res.status(403).json({ error: 'Bu mesajÄ± okundu olarak iÅŸaretleme yetkiniz yok' });
    }
    
    const updated = dbQuery.updateMessage(req.params.id, { read: true });
    if (updated) {
      res.json(updated);
    } else {
      res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ==================== ADMIN MESSAGES ROUTES ====================

// TÃ¼m mesajlarÄ± getir (Admin)
app.get('/api/admin/messages', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const allMessages = dbQuery.getAllMessages();
    const allUsers = dbQuery.getUsers();
    const allListings = dbQuery.getListings();
    
    // Mesajlara gÃ¶nderen, alÄ±cÄ± ve ilan bilgilerini ekle
    const messagesWithDetails = allMessages.map(msg => {
      const sender = allUsers.find(u => u.id === msg.senderId);
      const receiver = allUsers.find(u => u.id === msg.receiverId);
      const listing = allListings.find(l => l.id === msg.listingId);
      
      return {
        ...msg,
        sender: sender ? {
          id: sender.id,
          displayName: sender.displayName,
          email: sender.email
        } : null,
        receiver: receiver ? {
          id: receiver.id,
          displayName: receiver.displayName,
          email: receiver.email
        } : null,
        listing: listing ? {
          id: listing.id,
          title: listing.title,
          category: listing.category
        } : null
      };
    });
    
    res.json(messagesWithDetails);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// Mesaj sil (Admin)
app.delete('/api/admin/messages/:id', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    // Admin iÃ§in mesajÄ± tamamen sil (her iki kullanÄ±cÄ± iÃ§in de)
    const message = dbQuery.getMessageById(req.params.id);
    if (!message) {
      return res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
    
    // Admin iÃ§in mesajÄ± tamamen sil
    const db = loadDatabase();
    if (!db.messages) {
      db.messages = [];
    }
    const index = db.messages.findIndex(m => m.id === req.params.id);
    if (index !== -1) {
      db.messages.splice(index, 1);
      saveDatabase(db);
      res.json({ success: true, message: 'Mesaj silindi' });
    } else {
      res.status(404).json({ error: 'Mesaj bulunamadÄ±' });
    }
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ==================== ADMIN USER DETAILS ROUTES ====================

// KullanÄ±cÄ±nÄ±n tÃ¼m mesajlarÄ±nÄ± getir (Admin)
app.get('/api/admin/user/:userId/messages', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { userId } = req.params;
    const allMessages = dbQuery.getAllMessages();
    
    // KullanÄ±cÄ±nÄ±n gÃ¶nderdiÄŸi veya aldÄ±ÄŸÄ± tÃ¼m mesajlarÄ± filtrele
    const userMessages = allMessages.filter(msg => 
      msg.senderId === userId || msg.receiverId === userId
    );
    
    // Ä°lan bilgilerini de ekle
    const messagesWithListing = userMessages.map(msg => {
      const listing = dbQuery.getListingById(msg.listingId);
      const sender = dbQuery.getUserById(msg.senderId);
      const receiver = dbQuery.getUserById(msg.receiverId);
      
      return {
        ...msg,
        listing: listing ? {
          id: listing.id,
          title: listing.title,
          category: listing.category
        } : null,
        sender: sender ? {
          id: sender.id,
          displayName: sender.displayName,
          email: sender.email
        } : null,
        receiver: receiver ? {
          id: receiver.id,
          displayName: receiver.displayName,
          email: receiver.email
        } : null
      };
    });
    
    res.json(messagesWithListing);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// KullanÄ±cÄ±nÄ±n konuÅŸmalarÄ±nÄ± getir
app.get('/api/conversations', authenticateToken, (req, res) => {
  try {
    console.log('ğŸ“¥ Conversations isteÄŸi alÄ±ndÄ±, userId:', req.userId);
    
    const conversations = dbQuery.getConversations(req.userId);
    console.log('âœ… Conversations yÃ¼klendi, sayÄ±:', conversations?.length || 0);
    console.log('ğŸ“‹ Conversations detay:', conversations.map(c => ({
      listingTitle: c.listingTitle,
      listingImage: c.listingImage,
      listingId: c.listingId
    })));
    
    // Ä°lan resim URL'lerini normalize et
    const normalizeImageUrl = (url) => {
      if (!url) return null;
      
      // Port numarasÄ±nÄ± dÃ¼zelt
      url = url.replace('localhost:3001', 'localhost:3000');
      
      // userId klasÃ¶rÃ¼nÃ¼ kaldÄ±r (eski format: /uploads/listings/userId/filename)
      // Yeni format: /uploads/listings/filename
      if (url.includes('/uploads/listings/')) {
        const parts = url.split('/uploads/listings/');
        if (parts.length > 1) {
          const pathParts = parts[1].split('/');
          // EÄŸer userId klasÃ¶rÃ¼ varsa (UUID formatÄ±nda) kaldÄ±r
          if (pathParts.length > 1 && pathParts[0].match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
            const filename = pathParts[pathParts.length - 1];
            url = `${req.protocol}://${req.get('host')}/uploads/listings/${filename}`;
          } else if (!url.startsWith('http')) {
            // Relative URL ise full URL'e Ã§evir
            url = `${req.protocol}://${req.get('host')}/uploads/listings/${pathParts[pathParts.length - 1]}`;
          }
        }
      } else if (url.startsWith('/uploads/')) {
        // Relative URL'leri full URL'e Ã§evir
        url = `${req.protocol}://${req.get('host')}${url}`;
      }
      
      return url;
    };
    
    // Her konuÅŸmanÄ±n listingImage'Ä±nÄ± normalize et
    const normalizedConversations = conversations.map(conv => {
      console.log('ğŸ” Normalize Ã¶ncesi conversation:', {
        listingTitle: conv.listingTitle,
        listingImage: conv.listingImage,
        listingId: conv.listingId,
        hasListingImage: !!conv.listingImage
      });
      
      const normalizedImage = conv.listingImage ? normalizeImageUrl(conv.listingImage) : null;
      console.log('ğŸ–¼ï¸ Normalize ediliyor:', {
        original: conv.listingImage,
        normalized: normalizedImage,
        listingTitle: conv.listingTitle
      });
      
      const result = {
        ...conv,
        listingImage: normalizedImage
      };
      
      console.log('âœ… Normalize sonrasÄ±:', {
        listingTitle: result.listingTitle,
        listingImage: result.listingImage
      });
      
      return result;
    });
    
    const allUsers = dbQuery.getUsers();
    console.log('âœ… Users yÃ¼klendi, sayÄ±:', allUsers?.length || 0);
    
    if (!Array.isArray(normalizedConversations)) {
      console.error('âŒ Conversations bir array deÄŸil:', typeof normalizedConversations);
      return res.status(500).json({ error: 'KonuÅŸmalar yÃ¼klenemedi' });
    }
    
    if (!Array.isArray(allUsers)) {
      console.error('âŒ Users bir array deÄŸil:', typeof allUsers);
      return res.status(500).json({ error: 'KullanÄ±cÄ±lar yÃ¼klenemedi' });
    }
    
    // Her konuÅŸmaya otherUserName ekle
    const conversationsWithNames = normalizedConversations.map(conv => {
      try {
        if (!conv || !conv.otherUserId) {
          console.warn('âš ï¸ GeÃ§ersiz conversation:', conv);
          return {
            ...conv,
            otherUserName: 'KullanÄ±cÄ±',
            listingImage: conv.listingImage || null
          };
        }
        
        const otherUser = allUsers.find(u => u && u.id === conv.otherUserId);
        const otherUserName = otherUser?.displayName?.trim() 
          ? otherUser.displayName.trim() 
          : (otherUser?.email || 'KullanÄ±cÄ±');
        
        console.log('ğŸ” Conversation mapping:', {
          listingTitle: conv.listingTitle,
          listingImage: conv.listingImage,
          listingId: conv.listingId,
          otherUserName: otherUserName
        });
        
        const result = {
          ...conv,
          otherUserName: otherUserName,
          listingImage: conv.listingImage || null
        };
        console.log('ğŸ“¤ Conversation result:', {
          listingTitle: result.listingTitle,
          listingImage: result.listingImage,
          listingId: result.listingId
        });
        return result;
      } catch (mapError) {
        console.error('âŒ Conversation map hatasÄ±:', mapError);
        return {
          ...conv,
          otherUserName: 'KullanÄ±cÄ±',
          listingImage: conv.listingImage || null
        };
      }
    });
    
    console.log('âœ… Conversations with names hazÄ±r, sayÄ±:', conversationsWithNames.length);
    res.json(conversationsWithNames);
  } catch (error) {
    console.error('âŒ Conversations endpoint hatasÄ±:', error);
    console.error('âŒ Hata detayÄ±:', error.stack);
    res.status(500).json({ error: error.message || 'KonuÅŸmalar yÃ¼klenirken hata oluÅŸtu' });
  }
});

// ==================== USERS ROUTES (Admin) ====================

// KullanÄ±cÄ± profil bilgilerini al (herkes gÃ¶rebilir) - Ã–NEMLÄ°: /api/users/:id, /api/users'den Ã–NCE olmalÄ±
app.get('/api/users/:id', authenticateToken, (req, res) => {
  try {
    console.log('ğŸ“¥ KullanÄ±cÄ± profil isteÄŸi:', req.params.id);
    console.log('ğŸ“¥ Ä°stek yapan kullanÄ±cÄ±:', req.userId);
    const user = dbQuery.getUserById(req.params.id);
    if (!user) {
      console.log('âŒ KullanÄ±cÄ± bulunamadÄ±:', req.params.id);
      return res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
    }
    const { password: _, ...userWithoutPassword } = user;
    console.log('âœ… KullanÄ±cÄ± profili gÃ¶nderiliyor:', userWithoutPassword.id, userWithoutPassword.displayName);
    res.json(userWithoutPassword);
  } catch (error) {
    console.error('âŒ KullanÄ±cÄ± profil hatasÄ±:', error);
    res.status(500).json({ error: error.message });
  }
});

// TÃ¼m kullanÄ±cÄ±larÄ± getir (Admin)
app.get('/api/users', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const users = dbQuery.getUsers();
    // Åifreleri response'dan Ã§Ä±kar
    const usersWithoutPasswords = users.map(u => {
      const { password: _, ...userWithoutPassword } = u;
      return userWithoutPassword;
    });
    
    res.json(usersWithoutPasswords);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// KullanÄ±cÄ± sil (Admin)
app.delete('/api/users/:id', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    if (req.params.id === req.userId) {
      return res.status(400).json({ error: 'Kendi hesabÄ±nÄ±zÄ± silemezsiniz' });
    }

    const deleted = dbQuery.deleteUser(req.params.id);
    if (deleted) {
      res.json({ success: true, message: 'KullanÄ±cÄ± silindi' });
    } else {
      res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
    }
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// KullanÄ±cÄ± durumunu deÄŸiÅŸtir (ban/unban)
app.put('/api/users/:id/status', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { isBanned } = req.body;
    const updated = dbQuery.updateUser(req.params.id, { isBanned: !!isBanned });
    
    if (updated) {
      const { password: _, ...userWithoutPassword } = updated;
      res.json(userWithoutPassword);
    } else {
      res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
    }
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// KullanÄ±cÄ± rolÃ¼nÃ¼ gÃ¼ncelle (Admin)
app.put('/api/users/:id/role', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { role } = req.body;
    if (!['user', 'admin', 'superadmin'].includes(role)) {
      return res.status(400).json({ error: 'GeÃ§ersiz rol' });
    }

    const updated = dbQuery.updateUser(req.params.id, { role });
    
    if (updated) {
      const { password: _, ...userWithoutPassword } = updated;
      res.json(userWithoutPassword);
    } else {
      res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
    }
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// KullanÄ±cÄ± profil gÃ¼ncelleme (kendi profilini gÃ¼ncelleyebilir)
// Profil resmi yÃ¼kleme iÃ§in multer middleware
const uploadProfile = multer({
  storage: multer.diskStorage({
    destination: (req, file, cb) => {
      const profileDir = path.join(uploadsDir, 'profiles');
      console.log('ğŸ“ Profile directory path:', profileDir);
      console.log('ğŸ“ Profile directory exists?', fs.existsSync(profileDir));
      
      if (!fs.existsSync(profileDir)) {
        console.log('ğŸ“ Creating profile directory...');
        fs.mkdirSync(profileDir, { recursive: true });
        console.log('âœ… Profile directory created:', profileDir);
      }
      
      // KlasÃ¶rÃ¼n yazÄ±labilir olduÄŸunu kontrol et
      try {
        fs.accessSync(profileDir, fs.constants.W_OK);
        console.log('âœ… Profile directory is writable');
      } catch (err) {
        console.error('âŒ Profile directory is NOT writable:', err);
      }
      
      cb(null, profileDir);
    },
    filename: (req, file, cb) => {
      const timestamp = Date.now();
      const sanitizedName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
      const filename = `${timestamp}_${sanitizedName}`;
      console.log('ğŸ“ Generated filename:', filename);
      console.log('ğŸ“ Original filename:', file.originalname);
      console.log('ğŸ“ File mimetype:', file.mimetype);
      cb(null, filename);
    }
  }),
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|gif|webp/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);
    if (extname && mimetype) {
      cb(null, true);
    } else {
      cb(new Error('Sadece resim dosyalarÄ± yÃ¼klenebilir!'));
    }
  },
  limits: { fileSize: 5 * 1024 * 1024 } // 5MB
});

// Multer error handler - tek bir tanÄ±m kullanÄ±yoruz (aÅŸaÄŸÄ±da 1263. satÄ±rda)

// Profil gÃ¼ncelleme endpoint'i - Multer'Ä± doÄŸrudan kullan
app.put('/api/users/:id/profile', (req, res, next) => {
  console.log('ğŸš¨ğŸš¨ğŸš¨ PROFÄ°L GÃœNCELLEME ENDPOINT\'Ä°NE Ä°STEK GELDÄ°! ğŸš¨ğŸš¨ğŸš¨');
  console.log('ğŸš¨ Method:', req.method);
  console.log('ğŸš¨ URL:', req.url);
  console.log('ğŸš¨ Params:', req.params);
  console.log('ğŸš¨ Content-Type:', req.get('Content-Type'));
  next();
}, authenticateToken, (req, res, next) => {
  console.log('ğŸ” Middleware baÅŸladÄ±');
  console.log('ğŸ” Content-Type:', req.get('Content-Type'));
  console.log('ğŸ” Is multipart?', req.is('multipart/form-data'));
  console.log('ğŸ” Method:', req.method);
  console.log('ğŸ” URL:', req.url);
  next();
}, (req, res, next) => {
  // Multer middleware'ini manuel olarak Ã§aÄŸÄ±r
  console.log('ğŸ”„ Multer middleware Ã§aÄŸrÄ±lÄ±yor...');
  console.log('ğŸ”„ req.body keys:', Object.keys(req.body || {}));
  console.log('ğŸ”„ req.headers content-type:', req.get('Content-Type'));
  
  uploadProfile.single('photo')(req, res, (err) => {
    if (err) {
      console.error('âŒ Multer hatasÄ±:', err);
      console.error('âŒ Multer hata detayÄ±:', err.message);
      console.error('âŒ Multer hata stack:', err.stack);
      return res.status(400).json({ error: err.message || 'Dosya yÃ¼kleme hatasÄ±' });
    }
    console.log('âœ… Multer middleware tamamlandÄ±');
    console.log('âœ… req.file:', req.file ? {
      filename: req.file.filename,
      path: req.file.path,
      size: req.file.size
    } : 'YOK - req.file undefined');
    console.log('âœ… req.body after multer:', req.body);
    next();
  });
}, (req, res) => {
  try {
    console.log('ğŸ“¥ Profil gÃ¼ncelleme isteÄŸi:', req.params.id);
    console.log('ğŸ“¥ req.body:', req.body);
    console.log('ğŸ“¥ req.body type:', typeof req.body);
    console.log('ğŸ“¥ req.body is undefined?', req.body === undefined);
    console.log('ğŸ“¥ req.body is null?', req.body === null);
    console.log('ğŸ“¥ req.file:', req.file ? {
      filename: req.file.filename,
      path: req.file.path,
      size: req.file.size,
      mimetype: req.file.mimetype,
      originalname: req.file.originalname,
      destination: req.file.destination
    } : 'YOK - req.file undefined');
    console.log('ğŸ“¥ req.files:', req.files);
    console.log('ğŸ“¥ Content-Type:', req.get('Content-Type'));
    console.log('ğŸ“¥ Is multipart?', req.is('multipart/form-data'));
    
    // KullanÄ±cÄ± sadece kendi profilini gÃ¼ncelleyebilir
    if (req.userId !== req.params.id) {
      return res.status(403).json({ error: 'Sadece kendi profilinizi gÃ¼ncelleyebilirsiniz' });
    }

    // req.body undefined ise boÅŸ obje kullan
    const body = req.body || {};
    console.log('ğŸ“¥ body after fallback:', body);
    
    // FormData'dan gelen deÄŸerler string olabilir
    const { displayName, phone, postalCode, email, address, showPhone, showAddress } = body;
    const updates = {};
    
    // TÃ¼m alanlarÄ± gÃ¼ncelle (undefined deÄŸilse)
    if (displayName !== undefined) updates.displayName = displayName;
    if (phone !== undefined) updates.phone = phone;
    if (postalCode !== undefined) updates.postalCode = postalCode;
    if (email !== undefined) updates.email = email;
    if (address !== undefined) updates.address = address;
    if (showPhone !== undefined) updates.showPhone = showPhone === 'true' || showPhone === true;
    if (showAddress !== undefined) updates.showAddress = showAddress === 'true' || showAddress === true;
    
    // Profil resmi yÃ¼klendiyse ekle
    if (req.file) {
      const photoURL = `${req.protocol}://${req.get('host')}/uploads/profiles/${req.file.filename}`;
      updates.photoURL = photoURL;
      console.log('âœ… Profil resmi yÃ¼klendi:', photoURL);
      console.log('âœ… Dosya bilgisi:', {
        filename: req.file.filename,
        path: req.file.path,
        size: req.file.size,
        destination: req.file.destination
      });
      
      // DosyanÄ±n gerÃ§ekten kaydedilip kaydedilmediÄŸini kontrol et
      const filePath = path.join(req.file.destination, req.file.filename);
      console.log('ğŸ“ Tam dosya yolu:', filePath);
      console.log('ğŸ“ req.file.path:', req.file.path);
      console.log('ğŸ“ req.file.destination:', req.file.destination);
      
      // Ã–nce req.file.path'i kontrol et (multer'Ä±n kaydettiÄŸi yer)
      if (fs.existsSync(req.file.path)) {
        console.log('âœ… Multer dosyayÄ± kaydetti:', req.file.path);
        const stats = fs.statSync(req.file.path);
        console.log('ğŸ“Š Dosya istatistikleri:', {
          size: stats.size,
          created: stats.birthtime,
          modified: stats.mtime
        });
        
        // DosyayÄ± hedef klasÃ¶re kopyala (eÄŸer orada deÄŸilse veya farklÄ±ysa)
        if (!fs.existsSync(filePath) || req.file.path !== filePath) {
          console.log('ğŸ”„ Dosya hedef klasÃ¶re kopyalanÄ±yor...');
          const profileDir = path.join(uploadsDir, 'profiles');
          if (!fs.existsSync(profileDir)) {
            fs.mkdirSync(profileDir, { recursive: true });
          }
          fs.copyFileSync(req.file.path, filePath);
          console.log('âœ… Dosya hedef klasÃ¶re kopyalandÄ±:', filePath);
        } else {
          console.log('âœ… Dosya zaten hedef klasÃ¶rde:', filePath);
        }
      } else {
        console.error('âŒ DOSYA HÄ°Ã‡BÄ°R YERDE YOK! req.file.path:', req.file.path);
      }
    } else {
      console.log('âš ï¸ Profil resmi yÃ¼klenmedi (req.file yok)');
      console.log('âš ï¸ req.body keys:', Object.keys(req.body || {}));
      console.log('âš ï¸ req.files:', req.files);
      // Resim yoksa mevcut photoURL'i koru - updates'e ekleme
      // EÄŸer FormData'da photoURL gÃ¶nderilmiÅŸse ve boÅŸ/null ise, mevcut deÄŸeri koru
      const currentUser = dbQuery.getUserById(req.params.id);
      if (currentUser && currentUser.photoURL) {
        console.log('ğŸ’¾ Mevcut photoURL korunuyor:', currentUser.photoURL);
        // Mevcut photoURL'i korumak iÃ§in updates'e eklemiyoruz
        // Sadece yeni resim yÃ¼klendiÄŸinde gÃ¼ncelliyoruz
      }
    }
    
    console.log('ğŸ“ GÃ¼ncellemeler:', updates);
    console.log('ğŸ“ updates iÃ§inde photoURL var mÄ±?', 'photoURL' in updates);

    // Mevcut kullanÄ±cÄ±yÄ± al (photoURL kontrolÃ¼ iÃ§in)
    const currentUser = dbQuery.getUserById(req.params.id);
    console.log('ğŸ“ Mevcut kullanÄ±cÄ± photoURL:', currentUser?.photoURL);
    
    // EÄŸer resim yÃ¼klenmediyse ve mevcut photoURL varsa, koru
    if (!req.file && currentUser && currentUser.photoURL && !('photoURL' in updates)) {
      console.log('ğŸ’¾ Mevcut photoURL korunuyor (updates\'e ekleniyor):', currentUser.photoURL);
      updates.photoURL = currentUser.photoURL;
    }

    console.log('ğŸ”„ Database gÃ¼ncellemesi baÅŸlatÄ±lÄ±yor...');
    console.log('ğŸ”„ updates tipi:', typeof updates);
    console.log('ğŸ”„ updates null mu?', updates === null);
    console.log('ğŸ”„ updates undefined mu?', updates === undefined);
    console.log('ğŸ”„ updates:', updates);
    
    // updates'in her zaman bir obje olduÄŸundan emin ol
    const safeUpdates = updates && typeof updates === 'object' ? updates : {};
    const updated = dbQuery.updateUser(req.params.id, safeUpdates);
    if (updated) {
      console.log('âœ… KullanÄ±cÄ± gÃ¼ncellendi:', updated.id);
      console.log('âœ… photoURL:', updated.photoURL);
      console.log('âœ… address:', updated.address);
      
      // Database'den tekrar oku ve kontrol et
      const dbCheck = dbQuery.getUserById(req.params.id);
      console.log('ğŸ” Database\'den tekrar okunan photoURL:', dbCheck?.photoURL);
      
      console.log('âœ… TÃ¼m kullanÄ±cÄ± bilgileri:', JSON.stringify(updated, null, 2));
      const { password: _, ...userWithoutPassword } = updated;
      console.log('ğŸ“¤ Frontend\'e gÃ¶nderilecek:', JSON.stringify(userWithoutPassword, null, 2));
      res.json(userWithoutPassword);
    } else {
      console.error('âŒ KullanÄ±cÄ± bulunamadÄ±:', req.params.id);
      res.status(404).json({ error: 'KullanÄ±cÄ± bulunamadÄ±' });
    }
  } catch (error) {
    console.error('âŒ Profil gÃ¼ncelleme hatasÄ±:', error);
    res.status(500).json({ error: error.message });
  }
});

// Admin tarafÄ±ndan kullanÄ±cÄ± oluÅŸtur
app.post('/api/users', authenticateToken, async (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { email, password, displayName, role = 'user' } = req.body;
    
    if (!email || !password || !displayName) {
      return res.status(400).json({ error: 'Email, ÅŸifre ve isim gerekli' });
    }

    // Email kontrolÃ¼
    const existingUser = dbQuery.getUserByEmail(email);
    if (existingUser) {
      return res.status(400).json({ error: 'Bu email zaten kullanÄ±lÄ±yor' });
    }

    // Åifreyi hashle
    const bcrypt = (await import('bcryptjs')).default;
    const hashedPassword = await bcrypt.hash(password, 10);

    // KullanÄ±cÄ±yÄ± oluÅŸtur
    const newUser = dbQuery.createUser({
      email,
      password: hashedPassword,
      displayName,
      role,
      photoURL: null,
      isBanned: false
    });

    const { password: _, ...userWithoutPassword } = newUser;
    res.status(201).json(userWithoutPassword);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ==================== STATISTICS ROUTES (Admin) ====================

// Admin istatistikleri
app.get('/api/admin/statistics', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    // KullanÄ±cÄ± istatistikleri
    const allUsers = dbQuery.getUsers();
    const adminUsers = allUsers.filter(u => u.role === 'admin' || u.role === 'superadmin').length;
    const regularUsers = allUsers.filter(u => u.role === 'user').length;

    // Ä°lan istatistikleri
    const allListings = dbQuery.getListings();
    const activeListings = allListings.filter(l => l.status === 'active').length;
    const inactiveListings = allListings.filter(l => l.status !== 'active').length;

    // Mesaj istatistikleri
    const allMessages = dbQuery.getMessages();
    const totalMessages = allMessages.length;

    // Son 7 gÃ¼n iÃ§indeki ilanlar
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const recentListings = allListings.filter(l => {
      const createdAt = new Date(l.createdAt);
      return createdAt >= sevenDaysAgo;
    }).length;

    // Kategori daÄŸÄ±lÄ±mÄ±
    const categoryCounts = {};
    allListings.forEach(listing => {
      categoryCounts[listing.category] = (categoryCounts[listing.category] || 0) + 1;
    });

    res.json({
      totalUsers: allUsers.length,
      adminUsers,
      regularUsers,
      totalListings: allListings.length,
      activeListings,
      inactiveListings,
      totalMessages,
      recentListings,
      categoryCounts
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ==================== YENÄ° REKLAM SÄ°STEMÄ° (6 Slot) ====================

// Aktif reklamlarÄ± getir (Public - rotasyon iÃ§in)
app.get('/api/advertisements', (req, res) => {
  try {
    console.log('ğŸ“¥ GET /api/advertisements - Ä°stek alÄ±ndÄ±');
    let ads;
    try {
      ads = getActiveAds();
      console.log('ğŸ“¥ GET /api/advertisements - getActiveAds sonucu:', Array.isArray(ads) ? `${ads.length} adet` : typeof ads);
    } catch (getError) {
      console.error('âŒ getActiveAds Ã§aÄŸrÄ±sÄ±nda hata:', getError);
      console.error('âŒ getActiveAds error stack:', getError.stack);
      return res.json([]);
    }
    
    if (Array.isArray(ads)) {
      return res.json(ads);
    }
    console.warn('âš ï¸ getActiveAds returned non-array:', ads);
    return res.json([]);
  } catch (error) {
    console.error('âŒ /api/advertisements error:', error);
    console.error('âŒ Error stack:', error.stack);
    return res.json([]);
  }
});

// TÃ¼m reklamlarÄ± getir (Admin)
app.get('/api/admin/advertisements', authenticateToken, (req, res) => {
  try {
    console.log('ğŸ“¥ GET /api/admin/advertisements - Ä°stek alÄ±ndÄ±');
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }
    
    let ads;
    try {
      ads = getAllAds();
      console.log('ğŸ“¥ GET /api/admin/advertisements - getAllAds sonucu:', typeof ads);
    } catch (getError) {
      console.error('âŒ getAllAds Ã§aÄŸrÄ±sÄ±nda hata:', getError);
      console.error('âŒ getAllAds error stack:', getError.stack);
      return res.json({
        ad1: { fileUrl: '', url: '', active: false },
        ad2: { fileUrl: '', url: '', active: false },
        ad3: { fileUrl: '', url: '', active: false },
        ad4: { fileUrl: '', url: '', active: false },
        ad5: { fileUrl: '', url: '', active: false },
        ad6: { fileUrl: '', url: '', active: false }
      });
    }
    
    if (ads && typeof ads === 'object') {
      return res.json(ads);
    }
    console.warn('âš ï¸ getAllAds returned invalid data:', ads);
    return res.json({
      ad1: { fileUrl: '', url: '', active: false },
      ad2: { fileUrl: '', url: '', active: false },
      ad3: { fileUrl: '', url: '', active: false },
      ad4: { fileUrl: '', url: '', active: false },
      ad5: { fileUrl: '', url: '', active: false },
      ad6: { fileUrl: '', url: '', active: false }
    });
  } catch (error) {
    console.error('âŒ /api/admin/advertisements GET error:', error);
    console.error('âŒ Error stack:', error.stack);
    return res.json({
      ad1: { fileUrl: '', url: '', active: false },
      ad2: { fileUrl: '', url: '', active: false },
      ad3: { fileUrl: '', url: '', active: false },
      ad4: { fileUrl: '', url: '', active: false },
      ad5: { fileUrl: '', url: '', active: false },
      ad6: { fileUrl: '', url: '', active: false }
    });
  }
});

// Reklam gÃ¼ncelle (Admin) - Slot bazlÄ±
// Ã–zel multer middleware: folder'Ä± 'advertisements' olarak sabit ayarla
const uploadAd = multer({
  storage: multer.diskStorage({
    destination: (req, file, cb) => {
      const folderPath = path.join(uploadsDir, 'advertisements');
      if (!fs.existsSync(folderPath)) {
        fs.mkdirSync(folderPath, { recursive: true });
      }
      console.log(`ğŸ“ Reklam dosyasÄ± kaydediliyor: ${folderPath}`);
      cb(null, folderPath);
    },
    filename: (req, file, cb) => {
      const timestamp = Date.now();
      const sanitizedName = file.originalname.replace(/[^a-zA-Z0-9.-]/g, '_');
      const ext = path.extname(sanitizedName);
      const name = path.basename(sanitizedName, ext);
      const uniqueName = `${timestamp}_${name}${ext}`;
      console.log(`ğŸ“ Reklam dosya adÄ±: ${uniqueName}`);
      cb(null, uniqueName);
    }
  }),
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
  },
  fileFilter: (req, file, cb) => {
    const allowedTypes = /jpeg|jpg|png|gif|webp/;
    const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
    const mimetype = allowedTypes.test(file.mimetype);
    if (mimetype && extname) {
      return cb(null, true);
    } else {
      cb(new Error('Sadece resim dosyalarÄ± yÃ¼klenebilir (JPEG, PNG, GIF, WEBP)'));
    }
  }
});

// Multer hata yakalama middleware
const handleMulterError = (err, req, res, next) => {
  if (err instanceof multer.MulterError) {
    console.error('âŒ Multer hatasÄ±:', err.message);
    return res.status(400).json({ error: `Dosya yÃ¼kleme hatasÄ±: ${err.message}` });
  } else if (err) {
    console.error('âŒ Dosya yÃ¼kleme hatasÄ±:', err.message);
    return res.status(400).json({ error: err.message || 'Dosya yÃ¼klenemedi' });
  }
  next();
};

app.put('/api/admin/advertisements/:slot', authenticateToken, uploadAd.single('file'), handleMulterError, (req, res) => {
  try {
    console.log('ğŸ“¥ PUT /api/admin/advertisements/:slot - Ä°stek alÄ±ndÄ±');
    console.log('ğŸ“¥ req.file:', req.file ? JSON.stringify({ filename: req.file.filename, path: req.file.path, size: req.file.size }) : 'YOK');
    console.log('ğŸ“¥ req.body:', JSON.stringify(req.body));
    
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { slot } = req.params;
    if (!slot || !slot.match(/^ad[1-6]$/)) {
      return res.status(400).json({ error: 'GeÃ§ersiz slot. ad1-ad6 arasÄ± olmalÄ±.' });
    }

    const { url, active } = req.body;
    
    let fileUrl = '';
    if (req.file) {
      // Dosya gerÃ§ekten kaydedildi mi kontrol et
      const filePath = req.file.path;
      if (fs.existsSync(filePath)) {
        const folder = 'advertisements';
        fileUrl = `/uploads/${folder}/${req.file.filename}`;
        fileUrl = `${req.protocol}://${req.get('host')}${fileUrl}`;
        console.log('âœ… Dosya yÃ¼klendi ve kaydedildi!');
        console.log('   ğŸ“ Dosya yolu:', filePath);
        console.log('   ğŸ”— fileUrl:', fileUrl);
      } else {
        console.error('âŒ Dosya kaydedilmedi! Yol:', filePath);
        return res.status(500).json({ error: 'Dosya kaydedilemedi' });
      }
    } else if (req.body.fileUrl) {
      fileUrl = req.body.fileUrl;
      console.log('ğŸ“ fileUrl body\'den alÄ±ndÄ±:', fileUrl);
    } else {
      console.warn('âš ï¸ Ne dosya ne de fileUrl var! Mevcut reklamÄ± gÃ¼ncellemeden devam ediliyor...');
    }

    const updateData = {
      url: url || '',
      active: active !== undefined ? (active === 'true' || active === true) : undefined
    };
    
    // fileUrl sadece varsa ekle
    if (fileUrl) {
      updateData.fileUrl = fileUrl;
    }
    
    console.log('ğŸ“ PUT /api/admin/advertisements/:slot - updateData:', JSON.stringify(updateData, null, 2));
    const updated = updateAd(slot, updateData);

    if (updated) {
      console.log('âœ… Reklam gÃ¼ncellendi:', slot);
      return res.json(updated);
    } else {
      console.error('âŒ Reklam gÃ¼ncellenemedi:', slot);
      return res.status(500).json({ error: 'Reklam gÃ¼ncellenemedi' });
    }
  } catch (error) {
    console.error('âŒ PUT /api/admin/advertisements/:slot error:', error);
    console.error('âŒ Error stack:', error.stack);
    return res.status(500).json({ error: error.message || 'Sunucu hatasÄ±' });
  }
});

// Reklam sil (Admin) - Slot'u temizle
app.delete('/api/admin/advertisements/:slot', authenticateToken, (req, res) => {
  try {
    const user = getUserById(req.userId);
    if (!user || (user.role !== 'admin' && user.role !== 'superadmin')) {
      return res.status(403).json({ error: 'Admin yetkisi gerekli' });
    }

    const { slot } = req.params;
    if (!slot || !slot.match(/^ad[1-6]$/)) {
      return res.status(400).json({ error: 'GeÃ§ersiz slot. ad1-ad6 arasÄ± olmalÄ±.' });
    }

    const deleted = deleteAd(slot);
    if (deleted) {
      res.json({ message: 'Reklam silindi' });
    } else {
      res.status(404).json({ error: 'Reklam bulunamadÄ±' });
    }
  } catch (error) {
    console.error('âŒ DELETE /api/admin/advertisements/:slot error:', error);
    res.status(500).json({ error: error.message });
  }
});

// Tek resim yÃ¼kleme
app.post('/api/upload', upload.single('image'), (req, res) => {
  try {
    if (!req.file) {
      return res.status(400).json({ error: 'Dosya yÃ¼klenmedi' });
    }

    // Folder parametresini iÅŸle (listings/userId formatÄ±nÄ± listings'e Ã§evir)
    let folder = req.body.folder || 'listings';
    // EÄŸer listings/userId formatÄ±ndaysa, sadece listings kullan
    if (folder.includes('/')) {
      folder = folder.split('/')[0]; // Sadece ilk kÄ±smÄ± al (listings)
    }

    // URL oluÅŸtur (userId klasÃ¶rÃ¼ olmadan)
    const fileUrl = `/uploads/${folder}/${req.file.filename}`;
    const fullUrl = `${req.protocol}://${req.get('host')}${fileUrl}`;

    res.json({
      success: true,
      url: fileUrl,
      fullUrl: fullUrl,
      filename: req.file.filename,
      size: req.file.size,
      mimetype: req.file.mimetype
    });
  } catch (error) {
    console.error('Upload error:', error);
    res.status(500).json({ error: error.message || 'Resim yÃ¼klenirken hata oluÅŸtu' });
  }
});

// Ã‡oklu resim yÃ¼kleme
app.post('/api/upload/multiple', upload.array('images', 10), (req, res) => {
  try {
    if (!req.files || req.files.length === 0) {
      return res.status(400).json({ error: 'Dosya yÃ¼klenmedi' });
    }

    // Folder parametresini iÅŸle (listings/userId formatÄ±nÄ± listings'e Ã§evir)
    let folder = req.body.folder || 'listings';
    // EÄŸer listings/userId formatÄ±ndaysa, sadece listings kullan
    if (folder.includes('/')) {
      folder = folder.split('/')[0]; // Sadece ilk kÄ±smÄ± al (listings)
    }

    const files = req.files.map(file => {
      const fileUrl = `/uploads/${folder}/${file.filename}`;
      const fullUrl = `${req.protocol}://${req.get('host')}${fileUrl}`;
      
      return {
        url: fileUrl,
        fullUrl: fullUrl,
        filename: file.filename,
        size: file.size,
        mimetype: file.mimetype
      };
    });

    res.json({
      success: true,
      files: files,
      count: files.length
    });
  } catch (error) {
    console.error('Upload error:', error);
    res.status(500).json({ error: error.message || 'Resimler yÃ¼klenirken hata oluÅŸtu' });
  }
});

// Resim silme
app.delete('/api/upload/:folder/:filename', (req, res) => {
  try {
    const { folder, filename } = req.params;
    const filePath = path.join(uploadsDir, folder, filename);

    if (fs.existsSync(filePath)) {
      fs.unlinkSync(filePath);
      res.json({ success: true, message: 'Dosya silindi' });
    } else {
      res.status(404).json({ error: 'Dosya bulunamadÄ±' });
    }
  } catch (error) {
    console.error('Delete error:', error);
    res.status(500).json({ error: error.message || 'Dosya silinirken hata oluÅŸtu' });
  }
});

// Hata yakalama middleware
app.use((error, req, res, next) => {
  if (error instanceof multer.MulterError) {
    if (error.code === 'LIMIT_FILE_SIZE') {
      return res.status(400).json({ error: 'Dosya boyutu Ã§ok bÃ¼yÃ¼k. Maksimum 10MB.' });
    }
  }
  res.status(500).json({ error: error.message || 'Sunucu hatasÄ±' });
});

// User Ratings & Comments Endpoints
// KullanÄ±cÄ± puanlarÄ±nÄ± getir
app.get('/api/users/:userId/ratings', authenticateToken, (req, res) => {
  try {
    const { userId } = req.params;
    const ratings = dbQuery.getUserRatings(userId);
    res.json(ratings);
  } catch (error) {
    console.error('âŒ Puanlar getirilemedi:', error);
    res.status(500).json({ error: error.message || 'Puanlar getirilemedi' });
  }
});

// KullanÄ±cÄ±ya puan ver
app.post('/api/users/:userId/ratings', authenticateToken, (req, res) => {
  try {
    const { userId } = req.params;
    const { rating } = req.body;
    
    if (!req.userId) {
      console.error('âŒ KullanÄ±cÄ± kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z - req.userId yok');
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    // Kendi kendine puan veremez
    if (req.userId === userId) {
      return res.status(400).json({ error: 'Kendi kendinize puan veremezsiniz' });
    }
    
    const ratingData = {
      userId: req.userId,
      ratedUserId: userId,
      rating: parseInt(rating)
    };
    const savedRating = dbQuery.createUserRating(ratingData);
    res.json(savedRating);
  } catch (error) {
    console.error('âŒ Puan kaydedilemedi:', error);
    // EÄŸer kullanÄ±cÄ± zaten puan vermiÅŸse 400 dÃ¶ndÃ¼r
    if (error.message && error.message.includes('zaten puan verdiniz')) {
      return res.status(400).json({ error: error.message });
    }
    res.status(500).json({ error: error.message || 'Puan kaydedilemedi' });
  }
});

// KullanÄ±cÄ± yorumlarÄ±nÄ± getir
app.get('/api/users/:userId/comments', authenticateToken, (req, res) => {
  try {
    const { userId } = req.params;
    const comments = dbQuery.getUserComments(userId);
    // Yorumlara kullanÄ±cÄ± bilgilerini ekle
    const commentsWithUsers = comments.map(comment => {
      const user = dbQuery.getUserById(comment.userId);
      return {
        ...comment,
        userName: user?.displayName || 'KullanÄ±cÄ±'
      };
    });
    res.json(commentsWithUsers);
  } catch (error) {
    console.error('âŒ Yorumlar getirilemedi:', error);
    res.status(500).json({ error: error.message || 'Yorumlar getirilemedi' });
  }
});

// KullanÄ±cÄ±ya yorum yap
app.post('/api/users/:userId/comments', authenticateToken, (req, res) => {
  try {
    console.log('ğŸ“¥ Yorum kaydetme isteÄŸi:', {
      userId: req.params.userId,
      body: req.body,
      authenticatedUserId: req.userId
    });
    
    const { userId } = req.params;
    const { comment, rating } = req.body;
    
    if (!req.userId) {
      console.error('âŒ KullanÄ±cÄ± kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z - req.userId yok');
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    // Kendi kendine yorum yapamaz
    if (req.userId === userId) {
      return res.status(400).json({ error: 'Kendi kendinize yorum yapamazsÄ±nÄ±z' });
    }
    
    const commentData = {
      userId: req.userId,
      ratedUserId: userId,
      comment: comment || '',
      rating: rating ? parseInt(rating) : 0
    };
    
    console.log('ğŸ’¾ Yorum verisi:', commentData);
    
    const savedComment = dbQuery.createUserComment(commentData);
    console.log('âœ… Yorum kaydedildi:', savedComment);
    
    const user = dbQuery.getUserById(req.userId);
    const response = {
      ...savedComment,
      userName: user?.displayName || 'KullanÄ±cÄ±'
    };
    
    console.log('ğŸ“¤ Yorum yanÄ±tÄ±:', response);
    res.json(response);
  } catch (error) {
    console.error('âŒ Yorum kaydedilemedi:', error);
    console.error('âŒ Hata stack:', error.stack);
    // EÄŸer kullanÄ±cÄ± zaten yorum yapmÄ±ÅŸsa 400 dÃ¶ndÃ¼r
    if (error.message && error.message.includes('zaten yorum yaptÄ±nÄ±z')) {
      return res.status(400).json({ error: error.message });
    }
    res.status(500).json({ error: error.message || 'Yorum kaydedilemedi' });
  }
});

// Ä°lanÄ± rezerve et
app.post('/api/listings/:listingId/reserve', jsonMiddleware, authenticateToken, async (req, res) => {
  try {
    console.log('ğŸ“¥ Rezervasyon isteÄŸi:', {
      listingId: req.params.listingId,
      body: req.body,
      userId: req.userId
    });
    
    const { listingId } = req.params;
    const { hours, sellerId } = req.body || {};
    
    if (!req.userId) {
      console.error('âŒ Kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z');
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    if (!hours || hours < 1 || hours > 168) {
      console.error('âŒ GeÃ§ersiz saat:', hours);
      return res.status(400).json({ error: 'Rezervasyon sÃ¼resi 1-168 saat arasÄ±nda olmalÄ±dÄ±r' });
    }
    
    const listing = dbQuery.getListingById(listingId);
    if (!listing) {
      console.error('âŒ Ä°lan bulunamadÄ±:', listingId);
      return res.status(404).json({ error: 'Ä°lan bulunamadÄ±' });
    }
    
    // Rezervasyon sÃ¼resini hesapla
    const endTime = new Date();
    endTime.setHours(endTime.getHours() + parseInt(hours));
    
    const reservationData = {
      listingId,
      reservedByUserId: req.userId,
      sellerId: sellerId || listing.userId,
      hours: parseInt(hours),
      endTime: endTime.toISOString()
    };
    
    console.log('ğŸ’¾ Rezervasyon verisi:', reservationData);
    
    const reservation = dbQuery.createReservation(reservationData);
    console.log('âœ… Rezervasyon oluÅŸturuldu:', reservation);
    
    // Rezerve eden kullanÄ±cÄ±nÄ±n adÄ±nÄ± al
    const reservedByUser = dbQuery.getUserById(req.userId);
    
    // Ä°lanla mesajlaÅŸan tÃ¼m kullanÄ±cÄ±lara bildirim gÃ¶nder (rezerve eden hariÃ§)
    const messageUsers = dbQuery.getListingMessageUsers(listingId);
    const reservedByUserName = reservedByUser?.displayName || 'KullanÄ±cÄ±';
    const reservationEndTime = new Date(reservation.endTime);
    const endTimeStr = reservationEndTime.toLocaleString('tr-TR', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    messageUsers.forEach(userId => {
      // Rezerve eden kullanÄ±cÄ±ya bildirim gÃ¶nderme
      if (userId !== req.userId) {
        dbQuery.createNotification({
          userId,
          listingId,
          type: 'reservation',
          title: 'Ä°lan Rezerve Edildi',
          message: `"${listing.title}" ilanÄ± ${reservedByUserName} tarafÄ±ndan ${endTimeStr} tarihine kadar rezerve edildi.`,
          listingTitle: listing.title,
          reservedByUserId: req.userId,
          reservedByName: reservedByUserName,
          endTime: reservation.endTime
        });
      }
    });
    
    const response = {
      ...reservation,
      reservedByName: reservedByUserName
    };
    
    console.log('ğŸ“¤ Rezervasyon yanÄ±tÄ±:', response);
    res.json(response);
  } catch (error) {
    console.error('âŒ Rezervasyon oluÅŸturulamadÄ±:', error);
    console.error('âŒ Hata stack:', error.stack);
    if (error.message && error.message.includes('zaten rezerve edilmiÅŸ')) {
      return res.status(400).json({ error: error.message });
    }
    res.status(500).json({ error: error.message || 'Rezervasyon oluÅŸturulamadÄ±' });
  }
});

// Ä°lan rezervasyon bilgisini getir
app.get('/api/listings/:listingId/reservation', (req, res) => {
  try {
    const { listingId } = req.params;
    console.log('ğŸ“¥ Rezervasyon bilgisi isteÄŸi:', listingId);
    
    const reservation = dbQuery.getReservation(listingId);
    console.log('ğŸ” Bulunan rezervasyon:', reservation ? {
      id: reservation.id,
      listingId: reservation.listingId,
      endTime: reservation.endTime,
      cancelled: reservation.cancelled,
      isExpired: reservation.endTime ? new Date(reservation.endTime) <= new Date() : false
    } : 'BulunamadÄ±');
    
    if (!reservation) {
      console.log('âœ… Rezervasyon yok, isReserved: false dÃ¶ndÃ¼rÃ¼lÃ¼yor');
      return res.json({ isReserved: false });
    }
    
    // End time kontrolÃ¼ - eÄŸer geÃ§miÅŸteyse rezervasyon geÃ§ersiz
    const endTime = new Date(reservation.endTime);
    const now = new Date();
    
    if (endTime <= now) {
      console.log('âš ï¸ Rezervasyon sÃ¼resi dolmuÅŸ:', { endTime, now });
      return res.json({ isReserved: false });
    }
    
    // Rezerve eden kullanÄ±cÄ±nÄ±n adÄ±nÄ± al
    const reservedByUser = dbQuery.getUserById(reservation.reservedByUserId);
    
    const response = {
      isReserved: true,
      ...reservation,
      reservedByName: reservedByUser?.displayName || 'KullanÄ±cÄ±'
    };
    
    console.log('âœ… Aktif rezervasyon dÃ¶ndÃ¼rÃ¼lÃ¼yor:', response);
    res.json(response);
  } catch (error) {
    console.error('âŒ Rezervasyon bilgisi getirilemedi:', error);
    console.error('âŒ Hata stack:', error.stack);
    res.status(500).json({ error: error.message || 'Rezervasyon bilgisi getirilemedi' });
  }
});

// Rezervasyonu iptal et
app.post('/api/listings/:listingId/reservation/cancel', authenticateToken, async (req, res) => {
  try {
    console.log('ğŸ“¥ Rezervasyon iptal isteÄŸi baÅŸladÄ±:', {
      listingId: req.params.listingId,
      userId: req.userId,
      method: req.method,
      url: req.url
    });
    
    const { listingId } = req.params;
    
    if (!req.userId) {
      console.error('âŒ Kimlik doÄŸrulamasÄ± baÅŸarÄ±sÄ±z - req.userId yok');
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    if (!listingId) {
      console.error('âŒ listingId eksik');
      return res.status(400).json({ error: 'Ä°lan ID gerekli' });
    }
    
    console.log('ğŸ”„ cancelReservation Ã§aÄŸrÄ±lÄ±yor...');
    const cancelled = dbQuery.cancelReservation(listingId, req.userId);
    
    if (!cancelled) {
      console.error('âŒ Rezervasyon bulunamadÄ± veya iptal edilemez:', { 
        listingId, 
        userId: req.userId,
        totalReservations: dbQuery.getReservation ? 'N/A' : 'N/A'
      });
      return res.status(404).json({ error: 'Rezervasyon bulunamadÄ± veya iptal edilemez' });
    }
    
    console.log('âœ… Rezervasyon iptal edildi:', cancelled);
    res.json({ success: true, message: 'Rezervasyon iptal edildi' });
  } catch (error) {
    console.error('âŒ Rezervasyon iptal edilemedi:', error);
    console.error('âŒ Hata mesajÄ±:', error.message);
    console.error('âŒ Hata stack:', error.stack);
    console.error('âŒ Hata detaylarÄ±:', {
      name: error.name,
      message: error.message,
      stack: error.stack
    });
    res.status(500).json({ 
      error: error.message || 'Rezervasyon iptal edilemedi',
      details: process.env.NODE_ENV === 'development' ? error.stack : undefined
    });
  }
});

// Ä°lan satÄ±ÅŸ bilgisini getir
app.get('/api/listings/:listingId/sale', (req, res) => {
  try {
    const { listingId } = req.params;
    console.log('ğŸ” SatÄ±ÅŸ bilgisi isteniyor, listingId:', listingId);
    const sale = dbQuery.getListingSale(listingId);
    console.log('ğŸ” SatÄ±ÅŸ bilgisi:', sale ? 'VAR' : 'YOK');
    if (sale) {
      res.json(sale);
    } else {
      // SatÄ±ÅŸ yoksa 200 ile null dÃ¶ndÃ¼r (frontend'de hata olarak algÄ±lanmasÄ±n)
      res.status(200).json(null);
    }
  } catch (error) {
    console.error('âŒ SatÄ±ÅŸ bilgisi alÄ±namadÄ±:', error);
    res.status(500).json({ error: error.message || 'SatÄ±ÅŸ bilgisi alÄ±namadÄ±' });
  }
});

// Ä°lanÄ± satÄ±ldÄ± olarak iÅŸaretle
app.post('/api/listings/:listingId/sold', authenticateToken, (req, res) => {
  try {
    const { listingId } = req.params;
    const { buyerId } = req.body;
    
    if (!req.userId) {
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    const listing = dbQuery.getListingById(listingId);
    if (!listing) {
      return res.status(404).json({ error: 'Ä°lan bulunamadÄ±' });
    }
    
    // Sadece ilan sahibi satÄ±ldÄ± olarak iÅŸaretleyebilir
    if (listing.userId !== req.userId) {
      return res.status(403).json({ error: 'Bu iÅŸlem iÃ§in yetkiniz yok' });
    }
    
    const saleData = {
      listingId,
      sellerId: req.userId,
      buyerId: buyerId || null,
      soldAt: new Date().toISOString()
    };
    
    const sale = dbQuery.markListingAsSold(saleData);
    
    // Ä°lanla mesajlaÅŸan tÃ¼m kullanÄ±cÄ±lara bildirim gÃ¶nder
    const messageUsers = dbQuery.getListingMessageUsers(listingId);
    
    messageUsers.forEach(userId => {
      // AlÄ±cÄ±ya ve diÄŸer ilgilenen kullanÄ±cÄ±lara bildirim gÃ¶nder
      dbQuery.createNotification({
        userId,
        listingId,
        type: 'sold',
        title: 'Ä°lan SatÄ±ldÄ±',
        message: `"${listing.title}" ilanÄ± satÄ±ldÄ± ve listeden kaldÄ±rÄ±ldÄ±.`,
        listingTitle: listing.title
      });
    });
    
    // SatÄ±cÄ± ve alÄ±cÄ±ya bildirim gÃ¶nder (mesaj olarak)
    if (buyerId) {
      const buyer = dbQuery.getUserById(buyerId);
      const seller = dbQuery.getUserById(req.userId);
      
      // Sadece alÄ±cÄ±ya bildirim mesajÄ± gÃ¶nder
      const buyerMessage = {
        id: uuidv4(),
        conversationId: `${buyerId}_${req.userId}_${listingId}`,
        senderId: req.userId,
        receiverId: buyerId,
        listingId,
        message: `${seller?.displayName || 'KullanÄ±cÄ±'} Bu IlanÄ± Size SattÄ±. KarÅŸÄ±lÄ±klÄ± Puan Vermeniz Ã–nerilir.`,
        timestamp: new Date().toISOString(),
        read: false
      };
      dbQuery.createMessage(buyerMessage);
    }
    
    res.json(sale);
  } catch (error) {
    console.error('âŒ Ä°lan satÄ±ldÄ± olarak iÅŸaretlenemedi:', error);
    res.status(500).json({ error: error.message || 'Ä°lan satÄ±ldÄ± olarak iÅŸaretlenemedi' });
  }
});

// ==================== NOTIFICATIONS ====================

// KullanÄ±cÄ±nÄ±n bildirimlerini getir
app.get('/api/notifications', authenticateToken, (req, res) => {
  try {
    if (!req.userId) {
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    const notifications = dbQuery.getUserNotifications(req.userId);
    res.json(notifications);
  } catch (error) {
    console.error('âŒ Bildirimler alÄ±namadÄ±:', error);
    res.status(500).json({ error: error.message || 'Bildirimler alÄ±namadÄ±' });
  }
});

// Bildirimi okundu olarak iÅŸaretle
app.put('/api/notifications/:id/read', authenticateToken, (req, res) => {
  try {
    if (!req.userId) {
      return res.status(401).json({ error: 'Kimlik doÄŸrulamasÄ± gerekli' });
    }
    
    const notification = dbQuery.markNotificationAsRead(req.params.id);
    if (!notification) {
      return res.status(404).json({ error: 'Bildirim bulunamadÄ±' });
    }
    
    // Bildirim kullanÄ±cÄ±ya ait mi kontrol et
    if (notification.userId !== req.userId) {
      return res.status(403).json({ error: 'Bu iÅŸlem iÃ§in yetkiniz yok' });
    }
    
    res.json(notification);
  } catch (error) {
    console.error('âŒ Bildirim okundu olarak iÅŸaretlenemedi:', error);
    res.status(500).json({ error: error.message || 'Bildirim okundu olarak iÅŸaretlenemedi' });
  }
});

// Server baÅŸlat
app.listen(PORT, '0.0.0.0', () => {
  console.log(`ğŸš€ Server Ã§alÄ±ÅŸÄ±yor: http://localhost:${PORT}`);
  console.log(`ğŸ“ Uploads directory: ${uploadsDir}`);
  console.log(`ğŸŒ Frontend URL: ${process.env.FRONTEND_URL || 'http://localhost:5173'}`);
  console.log(`âœ… Backend hazÄ±r ve istekleri bekliyor!`);
  console.log(`ğŸ” Profil gÃ¼ncelleme endpoint: PUT /api/users/:id/profile`);
  console.log(`ğŸ” KullanÄ±cÄ± profil endpoint: GET /api/users/:id`);
  console.log(`ğŸ” TÃ¼m istekler loglanacak!`);
});

